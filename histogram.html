<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>混雑ヒストグラム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(to right, #a1c4fd, #c2e9fb);
      color: #2c3e50;
    }
    header {
      background-color: #2c3e50;
      color: white;
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
    }
    .header-title {
      font-size: 1.5em;
      font-weight: bold;
    }
    .header-links {
      display: flex;
      gap: 20px;
    }
    .header-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
    }
    .header-links a:hover {
      text-decoration: underline;
    }
    nav {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      background-color: #3498db;
      text-align: center;
      border-top: 1px solid #fff;
      border-bottom: 1px solid #fff;
    }
    nav a {
      padding: 12px 0;
      display: block;
      color: white;
      text-decoration: none;
      font-weight: bold;
      border-right: 1px solid #fff;
    }
    nav a:last-child {
      border-right: none;
    }
    nav a.active {
      background-color: #1f618d;
    }
    nav a:hover {
      background-color: #2980b9;
    }
    main {
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    canvas {
      width: 100%;
      height: 300px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-bar">
      <div class="header-title">店内管理システム</div>
      <div class="header-links">
        <a href="#">マニュアル</a>
        <a href="#">ログアウト</a>
      </div>
    </div>
    <nav>
      <a href="index.html">ホーム</a>
      <a href="map.html">店内マップ</a>
      <a href="log.html">ログ一覧</a>
      <a href="admin.html">待ち管理</a>
    </nav>
  </header>
  <main>
    <div class="controls">
      <label>日付選択: <input type="date" id="datePicker"></label>
      <label>時間間隔:
        <select id="interval">
          <option value="60">1時間</option>
          <option value="30">30分</option>
          <option value="15">15分</option>
        </select>
      </label>
    </div>
    <canvas id="histogram"></canvas>
    <table>
      <thead>
        <tr><th>日付</th><th>時間帯</th><th>テーブル</th><th>滞在時間</th></tr>
      </thead>
      <tbody id="logTable"></tbody>
    </table>
  </main>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const ctx = document.getElementById("histogram").getContext("2d");
    let chart;

    function formatTimeRange(date, hour, minute, interval) {
      const start = new Date(date);
      start.setHours(hour, minute, 0);
      const end = new Date(start.getTime() + interval * 60000);
      return `${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}〜${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;
    }

    async function fetchData() {
      const selectedDate = document.getElementById("datePicker").value;
      const interval = parseInt(document.getElementById("interval").value);
      if (!selectedDate) return;
      const snapshot = await db.collection("logs").orderBy("timestamp").get();

      const logs = snapshot.docs.map(doc => doc.data()).filter(data => {
        return data.timestamp && data.timestamp.startsWith(selectedDate);
      });

      const grouped = {};
      const enterMap = {};
      const detailRows = [];
      for (let hour = 0; hour < 24; hour++) {
        for (let min = 0; min < 60; min += interval) {
          const label = formatTimeRange(selectedDate, hour, min, interval);
          grouped[label] = 0;
        }
      }

      logs.forEach(data => {
        const ts = new Date(data.timestamp);
        const key = `${data.table}-${data.type}`;
        if (data.type === "enter") {
          enterMap[data.table] = ts;
        } else if (data.type === "exit" && enterMap[data.table]) {
          const stay = Math.round((ts - enterMap[data.table]) / 60000);
          const row = `<tr><td>${selectedDate}</td><td>${enterMap[data.table].toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</td><td>${data.table}</td><td>${stay}分</td></tr>`;
          detailRows.push(row);
          const intervalStart = new Date(enterMap[data.table]);
          intervalStart.setMinutes(Math.floor(intervalStart.getMinutes() / interval) * interval);
          const label = formatTimeRange(selectedDate, intervalStart.getHours(), intervalStart.getMinutes(), interval);
          if (grouped[label] !== undefined) grouped[label]++;
          delete enterMap[data.table];
        }
      });

      document.getElementById("logTable").innerHTML = detailRows.join("\n");

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: Object.keys(grouped),
          datasets: [{
            label: "入店数",
            data: Object.values(grouped),
            backgroundColor: "rgba(52, 152, 219, 0.7)"
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: "時間帯" } },
            y: { title: { display: true, text: "入店数" }, beginAtZero: true }
          }
        }
      });
    }

    document.getElementById("datePicker").valueAsDate = new Date();
    document.getElementById("datePicker").addEventListener("change", fetchData);
    document.getElementById("interval").addEventListener("change", fetchData);
    fetchData();
  </script>
</body>
</html>
