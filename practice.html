<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>テーブル管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <!-- 背景用グラデーション -->
  <style>
    body {
      background: linear-gradient(to right, #e0f7fa, #fff3e0);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- ハンバーガーメニュー -->
  <header class="bg-orange-400 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">テーブル管理</h1>
    <button id="menuButton" class="focus:outline-none">
      <svg class="w-6 h-6 fill-current" viewBox="0 0 20 20"><path d="M0 3h20v2H0zM0 9h20v2H0zM0 15h20v2H0z"/></svg>
    </button>
  </header>

  <!-- ドロワーメニュー -->
  <aside id="drawerMenu" class="fixed top-0 left-0 w-64 bg-white h-full shadow transform -translate-x-full transition-transform duration-300 z-50">
    <nav class="p-4">
      <ul>
        <li class="mb-2"><a href="index.html" class="text-blue-600">ホーム</a></li>
        <li class="mb-2"><a href="map.html" class="text-blue-600">マップ</a></li>
        <li class="mb-2"><a href="table.html" class="font-bold">テーブル管理</a></li>
      </ul>
    </nav>
  </aside>

  <!-- コンテンツ -->
  <main class="p-4 mt-4 space-y-6">
    <!-- テーブル状態 -->
    <section>
      <h2 class="text-xl font-bold mb-2">現在のテーブル状況</h2>
      <div id="tableList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- 使用履歴 -->
    <section>
      <h2 class="text-xl font-bold mb-2">使用履歴</h2>
      <div id="historyList" class="space-y-2"></div>
    </section>
  </main>

  <!-- ドロワーの開閉処理 -->
  <script>
    const menuButton = document.getElementById('menuButton');
    const drawerMenu = document.getElementById('drawerMenu');
    menuButton.addEventListener('click', () => {
      drawerMenu.classList.toggle('-translate-x-full');
    });
  </script>

  <!-- Firebaseとデータ処理 -->
  <script>
    // Firebase初期化
    const firebaseConfig = {
      // あなたのFirebase設定情報をここに
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ログを取得してテーブル状態と履歴を表示
    const tableListEl = document.getElementById('tableList');
    const historyListEl = document.getElementById('historyList');

    const latestEnterLogs = {};  // 最新の入店ログを追跡
    const tableHistories = {};   // 各テーブルの履歴

    db.collection("logs").orderBy("timestamp", "desc").onSnapshot(snapshot => {
      latestEnterLogs = {};
      tableHistories = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        const { table, type, timestamp, device } = data;

        // 使用履歴保存
        if (!tableHistories[table]) tableHistories[table] = [];
        tableHistories[table].push({ type, timestamp, device });

        // 最新の入店情報だけ保存
        if (type === 'enter' && !latestEnterLogs[table]) {
          latestEnterLogs[table] = new Date(timestamp);
        } else if (type === 'exit') {
          delete latestEnterLogs[table]; // 退店したら状態解除
        }
      });

      // 状況表示更新
      renderTableStatus();
      renderHistory();
    });

    function renderTableStatus() {
      tableListEl.innerHTML = '';
      const tableIDs = Object.keys(tableHistories).sort();

      tableIDs.forEach(table => {
        const status = latestEnterLogs[table] ? "使用中" : "空き";
        const startTime = latestEnterLogs[table];
        let timeInfo = '';

        if (startTime) {
          const now = new Date();
          const diffMs = now - startTime;
          const minutes = Math.floor(diffMs / 60000);
          timeInfo = `（経過: ${minutes}分）`;
        }

        const card = `
          <div class="p-4 rounded-lg shadow bg-white">
            <h3 class="font-bold text-lg">テーブル ${table}</h3>
            <p class="${status === '使用中' ? 'text-red-500' : 'text-green-500'} font-semibold">${status} ${timeInfo}</p>
          </div>
        `;
        tableListEl.innerHTML += card;
      });
    }

    function renderHistory() {
      historyListEl.innerHTML = '';
      const tableIDs = Object.keys(tableHistories).sort();

      tableIDs.forEach(table => {
        const logs = tableHistories[table];
        const historyHTML = logs.map(log => {
          const time = new Date(log.timestamp).toLocaleString();
          return `<li>${time} - ${log.type === 'enter' ? '入店' : '退店'}（Device: ${log.device}）</li>`;
        }).join('');

        const section = `
          <div class="p-4 bg-white rounded-lg shadow">
            <h4 class="font-semibold mb-2">テーブル ${table}</h4>
            <ul class="list-disc pl-5 text-sm">${historyHTML}</ul>
          </div>
        `;
        historyListEl.innerHTML += section;
      });
    }
  </script>

</body>
</html>
