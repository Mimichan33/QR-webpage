<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    .stat {
      font-size: 16px;
      margin: 6px 0;
    }
    canvas {
      max-width: 100%;
      height: 320px !important;
    }
    .small-row {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge {
      background:#eef;
      padding:6px 10px;
      border-radius:999px;
      font-weight:600;
      font-size:14px;
    }
  </style>
</head>
<body>
  <h1>入店者ダッシュボード</h1>

  <div class="grid">
    <div class="card">
      <h2>本日の入退店数</h2>
      <div class="small-row">
        <p class="stat">現在館内人数: <span id="count">0</span></p>
        <p class="stat">入店数: <span id="entries">0</span></p>
        <p class="stat">退店数: <span id="exits">0</span></p>
        <p class="stat">待機数: <span id="waitingCount">0</span></p>
      </div>
      <p class="stat">※テーブルごとのステータスは下の「テーブル状況」を参照</p>
    </div>

    <div class="card">
      <h2>本日の入店数（時間別・折れ線）</h2>
      <canvas id="todayLineChart"></canvas>
    </div>

    <div class="card">
      <h2>過去30日間 入店者数推移</h2>
      <canvas id="activityLineChart"></canvas>
    </div>

    <div class="card">
      <h2>入店 vs 退店 (本日)</h2>
      <canvas id="todayPieChart"></canvas>
    </div>

    <div class="card">
      <h2>曜日ごとの平均入店数</h2>
      <canvas id="weekdayBarChart"></canvas>
    </div>

    <div class="card">
      <h2>時間帯別 平均入店数（過去30日）</h2>
      <canvas id="hourlyBarChart"></canvas>
    </div>

    <div class="card">
      <h2>過去30日：7日移動平均</h2>
      <canvas id="movingAvgLineChart"></canvas>
    </div>

    <div class="card">
      <h2>テーブル状況（例）</h2>
      <div id="tablesContainer" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:8px;">
        <div id="table1-status" class="badge">テーブル1: 読み込み中</div>
        <div id="table2-status" class="badge">テーブル2: 読み込み中</div>
        <div id="table3-status" class="badge">テーブル3: 読み込み中</div>
        <div id="table4-status" class="badge">テーブル4: 読み込み中</div>
        <div id="table5-status" class="badge">テーブル5: 読み込み中</div>
        <div id="table6-status" class="badge">テーブル6: 読み込み中</div>
        <div id="table7-status" class="badge">テーブル7: 読み込み中</div>
        <div id="table8-status" class="badge">テーブル8: 読み込み中</div>
        <div id="table9-status" class="badge">テーブル9: 読み込み中</div>
        <div id="table10-status" class="badge">テーブル10: 読み込み中</div>
        <div id="table11-status" class="badge">テーブル11: 読み込み中</div>
        <div id="table12-status" class="badge">テーブル12: 読み込み中</div>
        <div id="table13-status" class="badge">テーブル13: 読み込み中</div>
        <div id="table14-status" class="badge">テーブル14: 読み込み中</div>
      </div>
    </div>
  </div>

  <script>
    // Firebase 設定（提供済みのものを使用）
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tableCounts = {};
    let todayLineChart, activityLineChart, todayPieChart, weekdayBarChart, hourlyBarChart, movingAvgLineChart;

    // --- タイムスタンプ処理（文字列も対応） ---
    function toDateFromTimestamp(maybeTs) {
      if (!maybeTs) return null;
      if (typeof maybeTs.toDate === "function") return maybeTs.toDate();
      if (maybeTs instanceof Date) return maybeTs;
      return new Date(maybeTs);
    }

    function formatTimestamp(isoString) {
      if (!isoString) return "ー";
      const date = new Date(isoString);
      const options = { timeZone:"Asia/Tokyo", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" };
      return new Intl.DateTimeFormat("ja-JP", options).format(date).replace(/\//g,"-").replace(",","");
    }

    function calculateElapsedTime(isoString) {
      if (!isoString) return "";
      const start = new Date(isoString);
      const now = new Date();
      const diffMs = now - start;
      if (diffMs < 0) return "";
      const minutes = Math.floor(diffMs/60000);
      const hours = Math.floor(minutes/60);
      const remainingMinutes = minutes % 60;
      return hours>0 ? `${hours}時間${remainingMinutes}分経過` : `${minutes}分経過`;
    }

    function updateTableDisplays() {
      Object.keys(tableCounts).forEach(tableNum=>{
        const t = tableCounts[tableNum];
        const currentCount = (t.enter||0) - (t.exit||0);
        const timeToShow = currentCount>0?t.lastEnterTime:null;
        const status = currentCount>0?"利用中":"空席";
        const timeText = timeToShow?formatTimestamp(timeToShow):"ー";
        const elapsed = currentCount>0?`｜${calculateElapsedTime(timeToShow)}`:"";
        const element = document.getElementById(`table${tableNum}-status`);
        if(element){
          element.textContent=`テーブル${tableNum}: ${status}（${timeText}${elapsed}）`;
        }
      });
    }

    // --- 来訪カウントとテーブル更新 ---
    function countVisitorsAndTables(snapshot){
      let entries=0, exits=0, waiting=0;
      for(let i=1;i<=14;i++){
        if(!tableCounts[i.toString()]) tableCounts[i.toString]={enter:0, exit:0, lastEnterTime:null};
        else { tableCounts[i.toString()].enter=0; tableCounts[i.toString()].exit=0; }
      }

      snapshot.forEach(doc=>{
        const data = doc.data();
        if(!data||!data.type) return;
        const type = data.type;
        const table = data.table;
        const ts = toDateFromTimestamp(data.timestamp);

        if(type==="enter") entries++;
        if(type==="exit") exits++;
        if(type==="wait") waiting++;

        if(table!==undefined && table!==null){
          const key = String(table);
          if(!tableCounts[key]) tableCounts[key]={enter:0, exit:0, lastEnterTime:null};
          if(type==="enter"){
            tableCounts[key].enter=(tableCounts[key].enter||0)+1;
            const prev = tableCounts[key].lastEnterTime?toDateFromTimestamp(tableCounts[key].lastEnterTime):null;
            if(!prev||(ts && ts>prev)) tableCounts[key].lastEnterTime=ts?ts.toISOString():tableCounts[key].lastEnterTime;
          }
          if(type==="exit") tableCounts[key].exit=(tableCounts[key].exit||0)+1;
        }
      });

      // 表示更新
      document.getElementById("count").textContent = Math.max(0, entries-exits);
      document.getElementById("entries").textContent = entries;
      document.getElementById("exits").textContent = exits;
      document.getElementById("waitingCount").textContent = waiting;

      // 円グラフ更新
      if(todayPieChart && todayPieChart.data && todayPieChart.data.datasets && todayPieChart.data.datasets[0]){
        todayPieChart.data.datasets[0].data = [entries, exits];
        todayPieChart.update();
      }

      updateTableDisplays();
    }

    // --- 本日の時間別折れ線（入店のみ） ---
    function updateTodayLine(snapshot){
      const hours = Array(24).fill(0);
      snapshot.forEach(doc=>{
        const data = doc.data();
        if(!data||data.type!=="enter") return;
        const ts = toDateFromTimestamp(data.timestamp)||new Date();
        const h = ts.getHours();
        hours[h]=(hours[h]||0)+1;
      });
      if(todayLineChart && todayLineChart.data && todayLineChart.data.datasets){
        todayLineChart.data.datasets[0].data = hours;
        todayLineChart.update();
      }
    }

    // --- 以下既存の過去30日・移動平均・曜日別・時間帯別処理はそのまま --- 
    async function loadPast30DaysAndMovingAvg(){ /* 既存コード */ }
    async function loadWeekdayStats(){ /* 既存コード */ }
    async function loadHourlyAverages(){ /* 既存コード */ }
    function initializeCharts(){ /* 既存コード */ }

    window.onload = ()=>{
      initializeCharts();

      const today = new Date();
      today.setHours(0,0,0,0);
      const todayTimestamp = firebase.firestore.Timestamp.fromDate(today);

      db.collection("logs")
        .where("timestamp", ">=", todayTimestamp)
        .onSnapshot(snapshot=>{
          countVisitorsAndTables(snapshot);
          updateTodayLine(snapshot);
        }, err=>{ console.error("今日のログ監視でエラー:", err); });

      loadPast30DaysAndMovingAvg().catch(e=>console.error(e));
      loadWeekdayStats().catch(e=>console.error(e));
      loadHourlyAverages().catch(e=>console.error(e));

      setInterval(updateTableDisplays,1000);

      const menuButton=document.querySelector(".menu-button");
      const drawer=document.querySelector(".drawer");
      if(menuButton && drawer){
        menuButton.addEventListener("click",()=>{ drawer.classList.toggle("open"); });
      }
    };
  </script>
</body>
</html>
