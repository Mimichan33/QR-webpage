<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .stat {
      font-size: 18px;
      margin: 5px 0;
    }
    canvas {
      max-width: 100%;
      height: 320px !important;
    }
  </style>
</head>
<body>
  <h1>入店者ダッシュボード</h1>

  <div class="grid">
    <div class="card">
      <h2>本日の入退店数</h2>
      <p class="stat">現在館内人数: <span id="count">0</span></p>
      <p class="stat">入店数: <span id="entries">0</span></p>
      <p class="stat">退店数: <span id="exits">0</span></p>
    </div>

    <div class="card">
      <h2>本日の入店数（推移）</h2>
      <canvas id="todayLineChart"></canvas>
    </div>

    <div class="card">
      <h2>過去30日間 入店者数推移</h2>
      <canvas id="activityLineChart"></canvas>
    </div>

    <div class="card">
      <h2>入店 vs 退店 (本日)</h2>
      <canvas id="todayPieChart"></canvas>
    </div>

    <div class="card">
      <h2>曜日ごとの平均入店数</h2>
      <canvas id="weekdayBarChart"></canvas>
    </div>
  </div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // グラフ用変数
    let todayLineChart, activityLineChart, todayPieChart, weekdayBarChart;

    // 本日の入退店数をカウント
    function countVisitors(snapshot) {
      let entries = 0, exits = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.type === "enter") entries++;
        if (data.type === "exit") exits++;
      });
      document.getElementById("count").textContent = entries - exits;
      document.getElementById("entries").textContent = entries;
      document.getElementById("exits").textContent = exits;

      // 円グラフ更新
      todayPieChart.data.datasets[0].data = [entries, exits];
      todayPieChart.update();
    }

    // 本日入店数の折れ線
    function updateTodayLine(snapshot) {
      const hours = Array(24).fill(0);
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.type !== "enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        hours[ts.getHours()]++;
      });
      todayLineChart.data.datasets[0].data = hours;
      todayLineChart.update();
    }

    // 過去30日間推移
    async function loadPast30Days() {
      const snapshot = await db.collection("logs").get();
      const today = new Date();
      today.setHours(0,0,0,0);

      const counts30 = Array(30).fill(0);
      const labels = [];

      for(let i=29;i>=0;i--){
        const d = new Date(today);
        d.setDate(today.getDate()-i);
        labels.push(`${d.getMonth()+1}/${d.getDate()}`);
      }

      snapshot.forEach(doc=>{
        const data = doc.data();
        if(data.type!=="enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        ts.setHours(0,0,0,0);
        const diff = Math.floor((today - ts)/(1000*60*60*24));
        if(diff>=0 && diff<30) counts30[29-diff]++;
      });

      activityLineChart.data.labels = labels;
      activityLineChart.data.datasets[0].data = counts30;
      activityLineChart.update();
    }

    // 曜日ごとの平均入店数
    async function loadWeekdayStats() {
      const snapshot = await db.collection("logs").get();
      const weekdayCounts = Array(7).fill(0);
      const weekdayTotals = Array(7).fill(0);

      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.type!=="enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        const w = ts.getDay();
        weekdayCounts[w]++;
        weekdayTotals[w]++;
      });

      const averages = weekdayTotals.map((v,i)=> v===0?0:weekdayCounts[i]);
      weekdayBarChart.data.datasets[0].data = averages;
      weekdayBarChart.update();
    }

    // 初期化
    function initializeCharts() {
      const ctx1 = document.getElementById("todayLineChart").getContext("2d");
      todayLineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: Array.from({length:24}, (_,i)=>`${i}時`),
          datasets: [{ label:"入店数", data:Array(24).fill(0), borderColor:"#007bff", fill:false }]
        }
      });

      const ctx2 = document.getElementById("activityLineChart").getContext("2d");
      activityLineChart = new Chart(ctx2, {
        type: "line",
        data: {
          labels: [],
          datasets: [{ label:"入店数", data:[], borderColor:"#28a745", fill:false }]
        }
      });

      const ctx3 = document.getElementById("todayPieChart").getContext("2d");
      todayPieChart = new Chart(ctx3, {
        type: "pie",
        data: {
          labels: ["入店","退店"],
          datasets: [{ data:[0,0], backgroundColor:["#007bff","#dc3545"] }]
        }
      });

      const ctx4 = document.getElementById("weekdayBarChart").getContext("2d");
      weekdayBarChart = new Chart(ctx4, {
        type: "bar",
        data: {
          labels:["日","月","火","水","木","金","土"],
          datasets:[{ label:"平均入店数", data:Array(7).fill(0), backgroundColor:"#17a2b8" }]
        }
      });
    }

    // メイン処理
    window.onload = () => {
      initializeCharts();
      const today = new Date();
      today.setHours(0,0,0,0);

      db.collection("logs")
        .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(today))
        .onSnapshot(snapshot => { 
          countVisitors(snapshot); 
          updateTodayLine(snapshot);
        });

      loadPast30Days();
      loadWeekdayStats();
    };
  </script>
</body>
</html>
