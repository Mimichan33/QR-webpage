<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>順番待ち確認</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <style>
    body { margin: 0; font-family: 'Helvetica Neue', sans-serif;
           background: linear-gradient(to right, #a1c4fd, #c2e9fb);
           color: #2c3e50; text-align: center; }
    .loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0;
              background: white; display: flex; flex-direction: column;
              justify-content: center; align-items: center; z-index: 9999; }
    .loading-bar { width: 220px; height: 20px; border: 2px solid #999;
                   border-radius: 10px; overflow: hidden; margin-top: 10px; }
    .loading-fill { height: 100%; width: 0%; background-color: #7baaf7;
                    animation: loading-animation 3s forwards; }
    .loading-text { font-size: 16px; margin-top: 10px; }
    @keyframes loading-animation { 0% { width: 0%; } 100% { width: 100%; } }
    .wait-section { display: none; padding: 60px 20px; }
    .wait-section h1 { font-size: 24px; margin-bottom: 20px; }
    .status-box { background: white; padding: 20px; margin: 20px auto;
                  border-radius: 15px; max-width: 320px;
                  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
    .highlight { font-size: 28px; font-weight: bold; color: #e74c3c; }
    .ticket-number { font-size: 22px; font-weight: bold; margin-top: 10px; color: #34495e; }
    .email-section { margin-top: 20px; }
    .email-section input { padding: 8px; font-size: 16px; width: 240px;
                           border-radius: 6px; border: 1px solid #999; }
    .email-section button { margin-left: 8px; padding: 8px 16px; font-size: 16px;
                            background-color: #3498db; color: white;
                            border: none; border-radius: 6px; cursor: pointer; }
  </style>
</head>
<body>

  <div class="loader" id="loader">
    <div class="loading-text" id="loadingLabel">Now Loading...</div>
    <div class="loading-bar"><div class="loading-fill"></div></div>
  </div>

  <div class="wait-section" id="waitSection">
    <h1>少々お待ちください<br><span style="font-size:16px;">Please wait a moment</span></h1>
    <p class="ticket-number" id="ticketNumber">番号札: --<br><span style="font-size:14px;">Ticket No.</span></p>

    <div class="status-box">
      <p>あなたの前に待っている人数：</p>
      <p class="highlight" id="peopleAhead">--</p>
      <p>予想待ち時間：</p>
      <p class="highlight" id="estimatedTime">--</p>
    </div>

    <div class="email-section">
      <label for="emailInput">メールで通知を希望する：</label><br>
      <input type="email" id="emailInput" placeholder="your@example.com" />
      <button onclick="submitEmail()">登録</button>
      <p id="emailStatus" style="margin-top:10px; font-size:14px; color:green;"></p>
    </div>
  </div>

  <div style="margin-top: 60px; padding: 20px 0; border-top: 2px solid #2c3e50; font-size: 18px;">
    <a href="/app/system/map.html" style="text-decoration: underline; color: #2c3e50;">
      店内マップ / Store Map
    </a>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let myDocId = null;
    let myIndex = -1;
    let ticketMap = {};
    let averageStayTime = 10; // 初期値（分）

    setTimeout(() => { $('#loadingLabel').text("Completion!"); }, 3000);
    setTimeout(() => { $('#loader').fadeOut(600); $('#waitSection').fadeIn(800); }, 4000);

    // 平均滞在時間を計算
    async function calculateAverageStayTime() {
      const snapshot = await db.collection("logs").orderBy("timestamp").get();
      const logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      let stayTimes = [];
      let enterMap = {};

      logs.forEach(log => {
        if (log.status === "enter") {
          enterMap[log.deviceId] = new Date(log.timestamp);
        } else if (log.status === "exit" && enterMap[log.deviceId]) {
          const enterTime = enterMap[log.deviceId];
          const exitTime = new Date(log.timestamp);
          const stayMinutes = (exitTime - enterTime) / 1000 / 60;
          if (stayMinutes > 0 && stayMinutes < 300) {
            stayTimes.push(stayMinutes);
          }
          delete enterMap[log.deviceId];
        }
      });

      if (stayTimes.length === 0) return 10;
      const avg = stayTimes.reduce((a, b) => a + b, 0) / stayTimes.length;
      return Math.round(avg);
    }

    async function registerQueue() {
      const docRef = await db.collection("queue").add({
        timestamp: new Date().toISOString(),
        status: "waiting",
        email: ""
      });
      myDocId = docRef.id;
    }

    function submitEmail() {
      const email = document.getElementById("emailInput").value.trim();
      const statusEl = document.getElementById("emailStatus");
      if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        statusEl.style.color = "red"; statusEl.textContent = "正しいメールアドレスを入力してください。"; return;
      }
      db.collection("queue").doc(myDocId).update({ email })
        .then(() => { statusEl.style.color = "green"; statusEl.textContent = "メールアドレスを登録しました。"; })
        .catch(() => { statusEl.style.color = "red"; statusEl.textContent = "登録に失敗しました。"; });
    }

    function watchQueue() {
      db.collection("queue").orderBy("timestamp").onSnapshot(snapshot => {
        const allDocs = snapshot.docs;
        const waitingList = allDocs.filter(doc => doc.data().status === "waiting");
        const selfDoc = snapshot.docs.find(doc => doc.id === myDocId);
        if (!selfDoc) return;
        const selfData = selfDoc.data();

        if (selfData.status === "expired") {
          location.href = "expired.html"; return;
        } else if (selfData.status === "entered") {
          sessionStorage.setItem("myDocId", myDocId);
          location.href = "admit.html"; return;
        }

        allDocs.forEach((doc, index) => {
          if (!(doc.id in ticketMap)) {
            ticketMap[doc.id] = index + 1;
          }
        });

        myIndex = ticketMap[myDocId];
        const peopleAhead = waitingList.filter(doc => ticketMap[doc.id] < myIndex).length;

        const estimated = (peopleAhead * averageStayTime);

        document.getElementById("ticketNumber").textContent = `番号札:  No. ${myIndex}`;
        const peopleAheadElement = document.getElementById("peopleAhead");
        if (peopleAhead === 0) {
          peopleAheadElement.innerHTML = `次はあなたの番です<br><span style="font-size:14px;">It's your turn next</span>`;
        } else {
          peopleAheadElement.textContent = `${peopleAhead}人`;
        }
        document.getElementById("estimatedTime").innerHTML = `約${estimated}分`;
      });
    }

    window.onload = async () => {
      averageStayTime = await calculateAverageStayTime(); // 実データから更新
      await registerQueue();
      watchQueue();
    };
  </script>
</body>
</html>

