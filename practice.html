<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>混雑傾向分析</title>

  <!-- Tailwind CSS (必要に応じて調整) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Swiper.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />

  <!-- Firebase SDK (バージョンはプロジェクトに合わせて) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-900 px-4 py-6">

  <h1 class="text-2xl font-bold mb-4">混雑傾向分析</h1>

  <!-- ここに既存のヒストグラムや履歴が入っていると仮定 -->

  <!-- ===== 新しい曜日別ヒストグラムセクション ===== -->
  <h2 class="text-xl font-bold mt-10 mb-4">曜日別混雑傾向（1時間ごと）</h2>

  <div class="swiper mySwiper w-full h-[400px] bg-white rounded-lg shadow">
    <div class="swiper-wrapper">
      <!-- JSで曜日ごとのスライド（グラフ）が追加されます -->
    </div>
    <div class="swiper-button-next"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-pagination"></div>
  </div>

  <!-- Firebase 初期化とカルーセルグラフ生成 -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script>
    // Firebase 設定
   const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 曜日 → 時間帯ごとのカウント（0〜23時）
    const weeklyData = {
      '日': Array(24).fill(0),
      '月': Array(24).fill(0),
      '火': Array(24).fill(0),
      '水': Array(24).fill(0),
      '木': Array(24).fill(0),
      '金': Array(24).fill(0),
      '土': Array(24).fill(0)
    };

    const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];

    db.collection("logs").get().then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        if (data.type !== "enter") return;

        const date = new Date(data.timestamp);
        const day = weekdayNames[date.getDay()];
        const hour = date.getHours();
        weeklyData[day][hour]++;
      });

      // 曜日ごとのグラフをカルーセルに追加
      const swiperWrapper = document.querySelector('.swiper-wrapper');

      weekdayNames.forEach(day => {
        const slide = document.createElement('div');
        slide.className = 'swiper-slide flex items-center justify-center';

        const canvas = document.createElement('canvas');
        canvas.id = `chart-${day}`;
        canvas.className = "w-full max-w-[90%] h-full";

        slide.appendChild(canvas);
        swiperWrapper.appendChild(slide);

        new Chart(canvas, {
          type: 'bar',
          data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}時`),
            datasets: [{
              label: `${day}曜日`,
              data: weeklyData[day],
              backgroundColor: 'rgba(54, 162, 235, 0.5)',
              borderColor: 'rgba(54, 162, 235, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: `${day}曜日の1時間ごとの来店数`
              }
            },
            scales: {
              y: {
                beginAtZero: true
              }
            }
          }
        });
      });

      // Swiper 初期化
      new Swiper(".mySwiper", {
        slidesPerView: 1,
        spaceBetween: 30,
        pagination: {
          el: ".swiper-pagination",
          clickable: true
        },
        navigation: {
          nextEl: ".swiper-button-next",
          prevEl: ".swiper-button-prev"
        },
        loop: true
      });
    });
  </script>
</body>
</html>

