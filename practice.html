<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ダッシュボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      margin: 0;
      padding: 20px;
      background: #f0f2f5;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .stat {
      font-size: 18px;
      margin: 5px 0;
    }
    canvas {
      max-width: 100%;
      height: 320px !important;
    }
  </style>
</head>
<body>
  <h1>入店者ダッシュボード</h1>

  <div class="grid">
    <div class="card">
      <h2>本日の入退店数</h2>
      <p class="stat">現在館内人数: <span id="count">0</span></p>
      <p class="stat">入店数: <span id="entries">0</span></p>
      <p class="stat">退店数: <span id="exits">0</span></p>
    </div>

    <div class="card">
      <h2>本日の入店数（推移）</h2>
      <canvas id="todayLineChart"></canvas>
    </div>

    <div class="card">
      <h2>過去30日間 入店者数推移</h2>
      <canvas id="activityLineChart"></canvas>
    </div>

    <div class="card">
      <h2>入店 vs 退店 (本日)</h2>
      <canvas id="todayPieChart"></canvas>
    </div>

    <div class="card">
      <h2>曜日ごとの平均入店数</h2>
      <canvas id="weekdayBarChart"></canvas>
    </div>
  </div>

  <script>
    // Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const tableCounts = {};

    


    // グラフ用変数
    let todayLineChart, activityLineChart, todayPieChart, weekdayBarChart;

    // 本日の入退店数をカウント
    function countVisitors(snapshot) {
      let entries = 0, exits = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.type === "enter") entries++;
        if (data.type === "exit") exits++;
      });
      document.getElementById("count").textContent = entries - exits;
      document.getElementById("entries").textContent = entries;
      document.getElementById("exits").textContent = exits;

      // 円グラフ更新
      todayPieChart.data.datasets[0].data = [entries, exits];
      todayPieChart.update();
    }

    // 本日入店数の折れ線
    function updateTodayLine(snapshot) {
      const hours = Array(24).fill(0);
      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.type !== "enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        hours[ts.getHours()]++;
      });
      todayLineChart.data.datasets[0].data = hours;
      todayLineChart.update();
    }

    // 過去30日間推移
    async function loadPast30Days() {
      const snapshot = await db.collection("logs").get();
      const today = new Date();
      today.setHours(0,0,0,0);

      const counts30 = Array(30).fill(0);
      const labels = [];

      for(let i=29;i>=0;i--){
        const d = new Date(today);
        d.setDate(today.getDate()-i);
        labels.push(`${d.getMonth()+1}/${d.getDate()}`);
      }

      snapshot.forEach(doc=>{
        const data = doc.data();
        if(data.type!=="enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        ts.setHours(0,0,0,0);
        const diff = Math.floor((today - ts)/(1000*60*60*24));
        if(diff>=0 && diff<30) counts30[29-diff]++;
      });

      activityLineChart.data.labels = labels;
      activityLineChart.data.datasets[0].data = counts30;
      activityLineChart.update();
    }

    // 曜日ごとの平均入店数
    async function loadWeekdayStats() {
      const snapshot = await db.collection("logs").get();
      const weekdayCounts = Array(7).fill(0);
      const weekdayTotals = Array(7).fill(0);

      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.type!=="enter") return;
        let ts = data.timestamp instanceof firebase.firestore.Timestamp ? data.timestamp.toDate() : new Date(data.timestamp);
        const w = ts.getDay();
        weekdayCounts[w]++;
        weekdayTotals[w]++;
      });

      const averages = weekdayTotals.map((v,i)=> v===0?0:weekdayCounts[i]);
      weekdayBarChart.data.datasets[0].data = averages;
      weekdayBarChart.update();
    }

    // 初期化
    function initializeCharts() {
      const ctx1 = document.getElementById("todayLineChart").getContext("2d");
      todayLineChart = new Chart(ctx1, {
        type: "line",
        data: {
          labels: Array.from({length:24}, (_,i)=>`${i}時`),
          datasets: [{ label:"入店数", data:Array(24).fill(0), borderColor:"#007bff", fill:false }]
        }
      });

      const ctx2 = document.getElementById("activityLineChart").getContext("2d");
      activityLineChart = new Chart(ctx2, {
        type: "line",
        data: {
          labels: [],
          datasets: [{ label:"入店数", data:[], borderColor:"#28a745", fill:false }]
        }
      });

      const ctx3 = document.getElementById("todayPieChart").getContext("2d");
      todayPieChart = new Chart(ctx3, {
        type: "pie",
        data: {
          labels: ["入店","退店"],
          datasets: [{ data:[0,0], backgroundColor:["#007bff","#dc3545"] }]
        }
      });

      const ctx4 = document.getElementById("weekdayBarChart").getContext("2d");
      weekdayBarChart = new Chart(ctx4, {
        type: "bar",
        data: {
          labels:["日","月","火","水","木","金","土"],
          datasets:[{ label:"平均入店数", data:Array(7).fill(0), backgroundColor:"#17a2b8" }]
        }
      });
    }



        function formatTimestamp(isoString) {
      if (!isoString || typeof isoString !== "string") return "ー";
      const date = new Date(isoString);
      const options = {
        timeZone: "Asia/Tokyo",
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      };
      return new Intl.DateTimeFormat("ja-JP", options).format(date).replace(/\//g, "-").replace(",", "");
    }


        function calculateElapsedTime(isoString) {
      if (!isoString) return "";
      const start = new Date(isoString);
      const now = new Date();
      const diffMs = now - start;
      if (diffMs < 0) return "";
      const minutes = Math.floor(diffMs / 60000);
      const hours = Math.floor(minutes / 60);
      const remainingMinutes = minutes % 60;
      return hours > 0 ? `${hours}時間${remainingMinutes}分経過` : `${minutes}分経過`;
    }

        function updateTableDisplays() {
      Object.keys(tableCounts).forEach(tableNum => {
        const t = tableCounts[tableNum];
        const currentCount = t.enter - t.exit;
        const timeToShow = currentCount > 0 ? t.lastEnterTime : null;
        const status = currentCount > 0 ? "利用中" : "空席";
        const timeText = formatTimestamp(timeToShow);
        const elapsed = currentCount > 0 ? `｜${calculateElapsedTime(timeToShow)}` : "";
        const element = document.getElementById(`table${tableNum}-status`);
        if (element) {
          element.textContent = `${status}（${timeText}${elapsed}）`;
        }
      });
    }

        function countVisitors(snapshot) {
      let entries = 0;
      let exits = 0;
      let waiting = 0;

      for (let i = 1; i <= 14; i++) {
        tableCounts[i.toString()] = {
          enter: 0,
          exit: 0,
          lastEnterTime: null
        };
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const table = data.table;
        const timestamp = data.timestamp;
        if (!table || !timestamp) return;

        if (data.type === "enter") entries++;
        if (data.type === "exit") exits++;
        if (data.type === "wait") waiting++;

        if (tableCounts[table]) {
          if (data.type === "enter") {
            tableCounts[table].enter++;
            if (!tableCounts[table].lastEnterTime || new Date(tableCounts[table].lastEnterTime) < new Date(timestamp)) {
              tableCounts[table].lastEnterTime = timestamp;
            }
          }
          if (data.type === "exit") {
            tableCounts[table].exit++;
          }
        }
      });

      document.getElementById("count").textContent = entries - exits;
      document.getElementById("entries").textContent = entries;
      document.getElementById("exits").textContent = exits;
      document.getElementById("waitingCount").textContent = waiting;

      updateTableDisplays();
    }

    // メイン処理
    window.onload = () => {
      initializeCharts();
      const today = new Date();
      today.setHours(0,0,0,0);

      db.collection("logs")
        .where("timestamp", ">=", firebase.firestore.Timestamp.fromDate(today))
        .onSnapshot(snapshot => { 
          countVisitors(snapshot); 
          updateTodayLine(snapshot);
        });

          const today = new Date();
    today.setHours(0, 0, 0, 0); // 今日の0時

    db.collection("logs")
      .where("timestamp", ">=", today.toISOString())  // ← フィルタを追加！
      .onSnapshot(countVisitors);

  setInterval(updateTableDisplays, 600);


      const menuButton = document.querySelector(".menu-button");
      const drawer = document.querySelector(".drawer");
      menuButton.addEventListener("click", () => {
        drawer.classList.toggle("open");
      });

      loadPast30Days();
      loadWeekdayStats();
    };
  </script>
</body>
</html>
