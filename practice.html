<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>テーブル管理</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, setDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let tableStatus = {};

    window.forceExit = async function(tableId, deviceId) {
      const confirmExit = confirm(`テーブル ${tableId} を強制退店させますか？`);
      if (!confirmExit) return;

      await addDoc(collection(db, "logs"), {
        table: tableId,
        type: "exit",
        timestamp: new Date().toISOString(),
        device: deviceId || "force-exit"
      });

      if (deviceId) {
        await setDoc(doc(db, "force_exit_flags", deviceId), {
          table: tableId,
          redirect: true,
          timestamp: new Date().toISOString()
        });
      }

      alert(`テーブル ${tableId} の強制退出処理を完了しました`);
    };

    onSnapshot(query(collection(db, "logs"), orderBy("timestamp")), snapshot => {
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const tableId = data.table;
        const deviceId = data.device;
        const timestamp = new Date(data.timestamp);
        const type = data.type;

        if (!tableStatus[tableId]) {
          tableStatus[tableId] = { status: "vacant", startTime: null, deviceId: null };
        }

        if (type === "enter") {
          tableStatus[tableId] = { status: "occupied", startTime: timestamp, deviceId };
        } else if (type === "exit") {
          tableStatus[tableId] = { status: "vacant", startTime: null, deviceId: null };
        }
      });

      const tbody = document.querySelector("#tableStatusTable tbody");
      tbody.innerHTML = "";

      for (const [tableId, info] of Object.entries(tableStatus)) {
        const tr = document.createElement("tr");
        tr.dataset.tableId = tableId;
        tr.className = info.status === "occupied" ? "occupied" : "vacant";

        const duration = info.status === "occupied" && info.startTime
          ? Math.floor((new Date() - info.startTime) / 60000)
          : "-";

        tr.innerHTML = `
          <td>${tableId}</td>
          <td>${info.status === "occupied" ? "使用中" : "空席"}</td>
          <td>${info.startTime ? info.startTime.toLocaleString() : "-"}</td>
          <td class="usage-time">${duration}</td>
          <td>${info.status === "occupied" ? `<button onclick="forceExit('${tableId}', '${info.deviceId}')">強制退出</button>` : "-"}</td>
        `;
        tbody.appendChild(tr);
      }
    });

    setInterval(() => {
      const now = new Date();
      for (const [tableId, info] of Object.entries(tableStatus)) {
        if (info.status === "occupied" && info.startTime) {
          const duration = Math.floor((now - info.startTime) / 60000);
          const row = document.querySelector(`#tableStatusTable tbody tr[data-table-id="${tableId}"]`);
          if (row) {
            row.querySelector(".usage-time").textContent = duration;
          }
        }
      }
    }, 60000);
  </script>
  <style>
    body { font-family: sans-serif; background: #f0f8ff; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #00796b; color: white; }
    .occupied { background: #ffdddd; }
    .vacant { background: #ddffdd; }
    button { padding: 6px 12px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>テーブル管理</h1>
  <table id="tableStatusTable">
    <thead>
      <tr>
        <th>テーブルID</th>
        <th>状態</th>
        <th>使用開始時刻</th>
        <th>利用時間（分）</th>
        <th>強制退出</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</body>
</html>
