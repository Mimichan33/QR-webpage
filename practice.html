<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>混雑傾向分析</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #f4f4f4;
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    .live-status {
      text-align: center;
      color: #d93025;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .tabs {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 5px;
      border: 1px solid #ccc;
      background: white;
    }
    .tab.active {
      background: #4285f4;
      color: white;
      border-color: #4285f4;
    }
    .carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE 10+ */
    }
    .carousel::-webkit-scrollbar {
      display: none; /* Chrome/Safari */
    }
    .carousel-item {
      min-width: 100%;
      scroll-snap-align: start;
    }
    canvas {
      width: 100% !important;
      max-width: 600px;
      height: 240px !important;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <h2>混雑傾向分析</h2>
  <div class="live-status" id="liveStatus"></div> <!-- 上に移動 -->
  <div class="tabs" id="tabs"></div>
  <div class="carousel" id="carousel"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const days = ["日", "月", "火", "水", "木", "金", "土"];
    const dayData = Array(7).fill().map(() => Array(24).fill(0));

    const now = new Date();
    const todayIndex = now.getDay();
    const currentHour = now.getHours();

    db.collection("logs")
      .where("type", "==", "enter")
      .get()
      .then(snapshot => {
        snapshot.forEach(doc => {
          const data = doc.data();
          const date = new Date(data.timestamp);
          const day = date.getDay();
          const hour = date.getHours();
          dayData[day][hour]++;
        });
        renderTabs();
        renderCharts();
        showLiveStatus();
      });

    function renderTabs() {
      const tabs = document.getElementById("tabs");
      days.forEach((day, i) => {
        const tab = document.createElement("div");
        tab.className = `tab${i === todayIndex ? " active" : ""}`;
        tab.innerText = day;
        tab.onclick = () => scrollToDay(i);
        tabs.appendChild(tab);
      });
    }

    function renderCharts() {
      const carousel = document.getElementById("carousel");
      days.forEach((day, i) => {
        const canvas = document.createElement("canvas");
        canvas.id = `chart-${i}`;
        const container = document.createElement("div");
        container.className = "carousel-item";
        container.appendChild(canvas);
        carousel.appendChild(container);

        const backgroundColors = Array(24).fill("rgba(100, 140, 230, 0.7)");
        if (i === todayIndex) backgroundColors[currentHour] = "rgba(220, 53, 69, 1)"; // 赤

        new Chart(canvas.getContext("2d"), {
          type: "bar",
          data: {
            labels: Array.from({ length: 24 }, (_, h) => `${h}時`),
            datasets: [{
              label: `${days[i]}曜日の混雑`,
              data: dayData[i],
              backgroundColor: backgroundColors,
              borderRadius: 8,
              barThickness: 16,
              maxBarThickness: 18,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: { display: false },
              x: { grid: { display: false } }
            },
            plugins: {
              legend: { display: false }
            }
          }
        });
      });
      scrollToDay(todayIndex);
    }

    function scrollToDay(index) {
      const carousel = document.getElementById("carousel");
      const width = carousel.offsetWidth;
      carousel.scrollTo({ left: width * index, behavior: "smooth" });

      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.querySelectorAll(".tab")[index].classList.add("active");
    }

    function showLiveStatus() {
      const count = dayData[todayIndex][currentHour];
      const liveStatus = document.getElementById("liveStatus");
      if (count > 0) {
        liveStatus.innerText = `● ライブ：やや混んでいます（${count}件）`;
      } else {
        liveStatus.innerText = `● ライブ：空いています`;
      }
    }
  </script>
</body>
</html>

