<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>入店確認</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>確認中...</h2>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJf3Z2Mg_J1uZ0kPa-sjcnLxs3BG4l5Ag",
      authDomain: "qr-visitor-log.firebaseapp.com",
      projectId: "qr-visitor-log",
      storageBucket: "qr-visitor-log.appspot.com",
      messagingSenderId: "304250341939",
      appId: "1:304250341939:web:b8d5b946590d1f852cf146"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function verifyToken() {
      const params = new URLSearchParams(location.search);
      const table = params.get("table");
      const token = params.get("token");
      if (!token || !table) return location.href = "expired2.html";

      const docRef = db.collection("qr_tokens").doc(token);
      const doc = await docRef.get();
      if (!doc.exists) return location.href = "expired2.html";

      const data = doc.data();
      const now = new Date();
      const expires = new Date(data.expiresAt);

      if (data.used) {
        location.href = "already-enter2.html";
      } else if (expires < now || data.table !== table) {
        location.href = "expired2.html";
      } else {
        await docRef.update({ used: true });
        await db.collection("logs").add({
          table: table,
          type: "enter",
          device: navigator.userAgent,
          timestamp: new Date().toISOString()
        });
        document.body.innerHTML = "<h2>ご入店ありがとうございます</h2>";
      }
    }

    verifyToken();
  </script>
</body>
</html>
